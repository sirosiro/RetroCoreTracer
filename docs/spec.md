
---

# Spec: Unified CPU Emulation Framework (Project: Retro core Tracer)

## 1. Project Vision (Manifesto)

> 「計算の本質を可視化する」
> 高層言語の抽象化に隠された「ビットの羅列（HEX）が意味（アセンブラ）へと昇華し、回路の脈動（バス）となって形を成すプロセス」を、一切の妥協なく可視化・構造化する。これは過去の遺産の保存ではなく、未来の設計思想を磨くための試練である。

## 2. Core Goals

* **教育的透明性:** 新人が内部構造（レジスタ、バス、フラグ）を直感的に理解できること。
* **設計の美しさ:** 複数アーキテクチャ（Z80, 6800等）を単一の抽象レイヤーで扱うクリーンな構造。
* **観測可能性 (Observability):** 実行の全プロセスが「非侵襲的」に監視・記録可能であること。

## 3. System Architecture

### 3.1 Layered Structure

1. **Transport Layer (Common Bus):** * アドレス空間の管理、メモリマップドI/Oの委譲。
* `read(addr)`, `write(addr, data)` の標準インターフェース。


2. **Core Layer (Abstract CPU):**
* 状態管理（PC, SP, Flags）の共通基盤。
* 命令サイクル（Fetch -> Decode -> Execute）の制御。


3. **Instruction Layer (Architecture Specific):**
* Z80 / 6800 固有の命令セット実装。
* CIPによる宣言的な命令定義。



### 3.2 Visualization Data Structure (The "Snapshot")

各実行ステップ（命令単位/マシンサイクル単位）で以下のデータを不変（Immutable）なオブジェクトとして発行する。

* `State`: 全レジスタの現在値、フラグビットの状態。
* `Operation`: 実行されたHEX、対応するMnemonic、オペランド。
* `BusActivity`: 直前のバス操作（R/W）、アクセスされたアドレス、流れたデータ。
* `Metadata`: シンボル情報（ラベル、コメント）、累計サイクル数。

## 4. Key Features

### 4.1 Hybrid Debugger (Dual View)

* **View A (Static/Expert):** レジスタダンプ、フラグ状態、メモリグリッド。
* **View B (Dynamic/Learner):** バス上のデータ移動のアニメーション、CPU内部ユニットの活性化。

### 4.2 Code Loader

* **Direct HEX:** バイナリファイル、Intel HEX形式のロード。
* **Annotated ASM:** アセンブリソースを直接読み込み、シンボル情報（ラベル名）をデバッガと共有。

### 4.3 Execution Control

* **Step-by-Instruction:** 1命令ごとの実行。
* **Step-by-Cycle:** 1クロック（Tステート）ごとの実行。
* **Breakpoints:** PC一致、特定アドレスへのアクセス（Read/Write）、レジスタ値の変化による停止。

---

## 5. Implementation Strategy (CIP Approach)

* **Intent-First:** 命令セットの仕様書をCIPメタデータとして定義し、ロジックを自動生成/検証する。
* **Decoupling:** CPUの実行ロジックは、UI（ビジュアライザー）の存在を一切知らない。

---

## 6. ユーザーインターフェース要件 (Visual Core)

* **デザインコンセプト:** 「サイバー・ミニマリズム」
* **配色:** ダークモードを基調（ベース: #1E1E1E）とし、アクセントカラーにネオンブルー（データ流出用）やアンバー（警告・停止用）を採用。
* **プロフェッショナルな外観:** VS Codeのようなモダンな開発環境の操作感を目指す。


* **レイアウト:** 3ペイン構成のダッシュボード
* **ナビゲーション（左）:** アセンブラソース、HEXビュー、ブレークポイント管理。
* **メインビジュアライザー（中央）:** アーキテクチャ図。バス上のデータ移動をアニメーションで表現（"Bus Glow" エフェクト）。
* **ステータスインスペクタ（右）:** レジスタ一覧、フラグビットの状態、スタックの視覚化。


* **視覚的フィードバック:**
* **リアルタイム・トレース:** 値が変化したレジスタやメモリ領域を、実行時に一瞬強調表示（フラッシュ）させる。
* **コンポーネント・ハイライト:** 現在実行中のフェーズ（フェッチ、デコード、実行）に合わせて、CPU内部の該当ユニット（ALUやPCなど）を活性化表示する。


* **インタラクティブ機能:**
* ソースコード上の行をクリックすることで、直感的にブレークポイントを設定。
* CPU各部にカーソルを合わせると、現在の役割や保持している値をツールチップで表示。

