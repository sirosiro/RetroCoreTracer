# src/retro_core_tracer/transport/ARCHITECTURE_MANIFEST.md

---
## Part 1: このマニフェストの取扱説明書 (Guide)

### 1. 目的 (Purpose): なぜこの憲章が存在するのか

このドキュメントは、プロジェクト「Retro Core Tracer」の特定モジュール「Transport Layer」の「北極星」です。開発者とAIが共有する高レベルな目標と、決して譲れない技術的・哲学的制約を定義します。

### 2. 憲章の書き方 (Guidelines)
*   **原則1: 具体的に記述する。**
*   **原則2: 「なぜ」に焦点を当てる。**
*   **原則3: 「禁止」ではなく「判断の背景」を記述する。**

---
## Part 2: マニフェスト本体 (Content)

### 1. 核となる原則 (Core Principles)

- **原則: バスアクセスは、アドレスとデータペイロードのみに限定される。**
  - **理由:** CPUコアからバスへのインターフェースをシンプルに保ち、下位レイヤー（デバイスドライバ）の複雑性を上位レイヤーに伝播させないため。

- **原則: メモリマップドI/Oを含む全てのアクセスは、単一のBusインターフェースを介して行われる。**
  - **理由:** CPUコア側がROM、RAM、I/Oを意識することなく、アドレス指定だけでアクセスを完結できるようにし、CPU実装の抽象度を高めるため。

### 2. コンポーネント設計仕様 (Component Design Specifications)

#### 4.1. BusAccessType (Enum)
- **責務:** バス上で発生する操作の種類（読み込みまたは書き込み）を明確に定義する。
    - `READ`, `WRITE`, `IO_READ`, `IO_WRITE`

#### 4.2. BusAccess (データクラス)
- **責務:** バス上で行われた個々のアクセス操作を不変な形式で記録する。
    - `address: int`, `data: int`, `access_type: BusAccessType`

#### 4.3. Device (抽象基底クラス)
- **責務:** バスに接続される全てのメモリマップドデバイス、またはI/Oデバイスが実装すべき標準インターフェースを定義する。
- **提供するAPI:**
    - `read(self, address: int) -> int`
    - `write(self, address: int, data: int) -> None`

#### 4.4. RAM (具象デバイス)
- **責務:** 読み書き可能なメモリ機能を提供する。
- **API:**
    - `read`: データを返す。
    - `write`: 内部バッファを更新する。

#### 4.5. ROM (具象デバイス)
- **責務:** 読み込み専用メモリ機能を提供する。
- **API:**
    - `read`: 初期化データを返す。
    - `write`: 何もしない、またはログ警告を出力する（例外は投げないことで実機の挙動に近づける）。
    - `load_data(self, data: bytes, offset: int) -> None`: 初期化時にデータをロードするためのバックドアメソッド。

#### 4.6. Bus (主要コンポーネント)
- **責務:** アドレス空間を一元管理し、アクセスを適切なデバイスへディスパッチする。全てのアクセスをログに記録する。
- **提供するAPI:**
    - `register_device(...)`
    - `read/write/peek`
    - `get_and_clear_activity_log()`
