# src/retro_core_tracer/loader/ARCHITECTURE_MANIFEST.md

---
## Part 1: このマニフェストの取扱説明書 (Guide)

### 1. 目的 (Purpose)
Loader Layerは、外部ファイル（HEXバイナリやアセンブリソース）を読み込み、システムバス経由でメモリに配置する責務を負います。

---
## Part 2: マニフェスト本体 (Content)

### 1. 核となる原則 (Core Principles)
- **原則: ローダーは、システムバスを介してのみメモリにアクセスする。**
- **原則: ローダーは入力データに対して「非侵襲的」かつ「忠実」でなければならない。**
  - **理由:** エミュレータの役割は、与えられたプログラムを正確に実行することである。ローダーが勝手に命令（例：HALTなど）を補完したり、データを改変したりすることは、実行結果の不確実性を招き、デバッグを困難にするため厳禁とする。
- **原則: 多様なバイナリフォーマットを抽象化し、一貫したロード体験を提供する。**
  - **理由:** Intel HEX (Z80) や Motorola S-Record (MC6800) など、アーキテクチャごとに異なる業界標準フォーマットを等しくサポートするため。

- **原則: アセンブリローダーは、指定されたターゲットアーキテクチャに基づいてパースを行う。**
  - **理由:** ニーモニックやアドレッシングモードの構文はCPUアーキテクチャごとに異なるため。

### 2. コンポーネント設計仕様 (Component Design Specifications)

#### 4.1. IntelHexLoader (クラス)
- **責務:** Intel HEX形式のファイルを解析し、バスにデータを書き込む。
- **拡張:** 16ビットを超えるアドレス指定（タイプ02, 04）にも対応する。

#### 4.2. SRecordLoader (クラス)
- **責務:** Motorola S-Record形式（S1, S2, S3レコード）を解析し、バスにデータを書き込む。
- **背景:** モトローラ系アーキテクチャでの開発親和性を高めるために導入。

#### 4.3. AssemblyLoader (クラス)
- **責務:** 簡易的なアセンブリソースコードファイルを解析し、シンボル情報を抽出すると共に、バイナリを生成してロードする。
- **アーキテクチャ別実装:**
    - **Z80**: 標準的なZ80ニーモニックをサポート。
    - **MC6800**: `ORG`, `DB` などの疑似命令、およびリセットベクトルの配置に必要なアドレス制御をサポート。
